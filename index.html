<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thread Synchronization äº’å‹•æ•™å­¸</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            height: 100%;
        }

        html {
            height: 100%;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            padding: 32px 24px;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 48px;
            font-size: 42px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .demo-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .demo-section h2 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 28px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
        }

        .demo-section h3 {
            color: #764ba2;
            margin-top: 24px;
            margin-bottom: 16px;
            font-size: 22px;
        }

        .explanation {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
            line-height: 1.8;
        }

        .visualization {
            display: flex;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .thread-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .thread-box.locked {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(17, 153, 142, 0.4);
        }

        .thread-box.working {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: working-pulse 0.8s ease-in-out;
        }

        @keyframes working-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .counter-display {
            background: #2d3748;
            color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            margin: 24px 0;
            font-family: 'Courier New', monospace;
        }

        .control-panel {
            display: flex;
            gap: 16px;
            margin: 24px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .code-example {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .code-keyword {
            color: #fc6b6b;
        }

        .code-function {
            color: #ffc947;
        }

        .code-comment {
            color: #90cdf4;
            font-style: italic;
        }

        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 16px 0;
        }

        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px solid #2d3748;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .log-entry.warning {
            color: #f6ad55;
        }

        .highlight-box {
            background: #e8f4fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 24px 0;
        }

        .highlight-box h4 {
            color: #1565c0;
            margin-top: 0;
            margin-bottom: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #48bb78;
            box-shadow: 0 0 8px #48bb78;
        }

        .status-indicator.waiting {
            background: #ed8936;
            box-shadow: 0 0 8px #ed8936;
        }

        .status-indicator.idle {
            background: #a0aec0;
        }

        .mutex-lock-container {
            background: #ffffff;
            border: 4px solid #cbd5e0;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transition: all 0.4s ease;
            min-width: 180px;
        }

        .mutex-lock-container.locked {
            border-color: #fc466b;
            background: #fff5f7;
            box-shadow: 0 8px 24px rgba(252, 70, 107, 0.3);
        }

        .lock-icon {
            font-size: 72px;
            margin-bottom: 12px;
            transition: transform 0.4s ease;
        }

        .mutex-lock-container.locked .lock-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .lock-status {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .mutex-lock-container.locked .lock-status {
            color: #c53030;
        }

        .lock-owner {
            font-size: 15px;
            color: #718096;
            font-weight: 600;
        }

        .mutex-lock-container.locked .lock-owner {
            color: #fc466b;
        }

        .mode-selector {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            background: #ffffff;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .comparison-table th {
            background: #667eea;
            color: #ffffff;
            padding: 16px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table tr:nth-child(even) {
            background: #f8f9ff;
        }

        .race-warning {
            background: #fff5f5;
            border: 3px solid #fc8181;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            font-weight: bold;
            color: #c53030;
            display: none;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .race-warning.show {
            display: block;
        }

        .semaphore-counter {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 24px 0;
        }

        .sem-slot {
            width: 60px;
            height: 60px;
            border: 3px solid #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .sem-slot.available {
            background: #c6f6d5;
            color: #22543d;
        }

        .sem-slot.taken {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container">
   <div class="content-wrapper">
    <h1>Thread Synchronization äº’å‹•æ•™å­¸</h1><!-- Mutex Interactive Demo -->
    <div class="demo-section">
     <h2>ğŸ”’ Mutex äº’å‹•é«”é©—ï¼šæ‰‹å‹•æ§åˆ¶ Lock/Unlock</h2>
     <div class="explanation"><strong>äº’å‹•æ–¹å¼ï¼š</strong>ä½ å¯ä»¥æ‰‹å‹•æ§åˆ¶å…©å€‹åŸ·è¡Œç·’çš„æ¯å€‹å‹•ä½œï¼<br><strong>ä½¿ç”¨ Mutexï¼š</strong>é«”é©—ã€Œèª° lock èª°æ‰èƒ½ unlockã€ï¼Œå…¶ä»–åŸ·è¡Œç·’å¿…é ˆç­‰å¾…ã€‚<br><strong>ä¸ä½¿ç”¨ Mutexï¼š</strong>å…©å€‹åŸ·è¡Œç·’åŒæ™‚æ“ä½œå…±äº«è®Šæ•¸ï¼Œæœƒç™¼ç”Ÿ Race Condition å°è‡´è¨ˆæ•¸éŒ¯èª¤ï¼
     </div>
     <div class="highlight-box">
      <h4>ğŸ”‘ Mutex Lock/Unlock é—œéµé‡é»</h4>
      <ul style="line-height: 2; margin: 0;">
       <li><strong>k_mutex_lock()</strong> - å˜—è©¦ã€Œå–å¾—é–ã€ï¼Œå¦‚æœå·²è¢«ä½”ç”¨å°±<strong>ç„¡æ³•åŸ·è¡Œ</strong>ï¼ˆæŒ‰éˆ•æœƒè¢«ç¦ç”¨ï¼‰</li>
       <li><strong>è‡¨ç•Œå€ (Critical Section)</strong> - åªæœ‰æŒæœ‰é–çš„åŸ·è¡Œç·’æ‰èƒ½å®‰å…¨åŸ·è¡Œ counter++</li>
       <li><strong>k_mutex_unlock()</strong> - åªæœ‰ã€ŒæŒæœ‰è€…ã€æ‰èƒ½é‡‹æ”¾ï¼Œå…¶ä»–åŸ·è¡Œç·’çš„ unlock æŒ‰éˆ•æœƒè¢«ç¦ç”¨</li>
       <li><strong>æ“æœ‰æ¬ŠåŸå‰‡</strong> - èª° lock å°±å¿…é ˆèª° unlockï¼ˆä¸èƒ½ç”±å…¶ä»–åŸ·è¡Œç·’ä»£å‹ï¼‰</li>
      </ul>
     </div>
     <div class="mode-selector"><strong style="font-size: 18px;">ğŸ® æ¨¡å¼é¸æ“‡ï¼š</strong>
      <div style="display: flex; gap: 12px; margin-top: 12px;"><button class="btn btn-success" id="mode-with-mutex" onclick="setMode(true)" style="flex: 1;">âœ… ä½¿ç”¨ Mutex ä¿è­·</button> <button class="btn btn-secondary" id="mode-without-mutex" onclick="setMode(false)" style="flex: 1;">âŒ ä¸ä½¿ç”¨ Mutexï¼ˆé«”é©— Race Conditionï¼‰</button>
      </div>
      <div id="current-mode" style="margin-top: 12px; text-align: center; font-weight: bold; font-size: 18px; color: #28a745;">
       ç•¶å‰æ¨¡å¼ï¼šâœ… ä½¿ç”¨ Mutex ä¿è­·
      </div>
     </div>
     <div class="race-warning" id="race-warning">
      âš ï¸ Race Condition ç™¼ç”Ÿï¼å…©å€‹åŸ·è¡Œç·’åŒæ™‚è®€å–ç›¸åŒå€¼ï¼Œå°è‡´å…¶ä¸­ä¸€æ¬¡ +1 å¤±æ•ˆï¼
     </div>
     <div class="visualization">
      <div style="flex: 1; min-width: 280px;">
       <div class="thread-box" id="mutex-t1">
        <div>
         <span class="status-indicator idle" id="mutex-t1-status"></span>åŸ·è¡Œç·’ 1
        </div>
        <div id="mutex-t1-count" style="font-size: 20px; margin: 12px 0;">
         å€‹äººè¨ˆæ•¸: 0
        </div>
        <div id="mutex-t1-state" style="font-size: 14px; opacity: 0.9;">
         ç‹€æ…‹: Idle
        </div>
       </div>
       <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;"><button class="btn" id="t1-lock-btn" onclick="threadLock(1)" style="font-size: 15px; padding: 12px;">ğŸ”’ k_mutex_lock()</button> <button class="btn" id="t1-unlock-btn" onclick="threadUnlock(1)" style="font-size: 15px; padding: 12px;" disabled>ğŸ”“ k_mutex_unlock()</button> <button class="btn btn-success" id="t1-counter-btn" onclick="threadIncrement(1)" style="font-size: 15px; padding: 12px;">â• counter++</button>
       </div>
      </div>
      <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 200px;">
       <div id="mutex-lock-visual" class="mutex-lock-container">
        <div class="lock-icon">
         ğŸ”“
        </div>
        <div class="lock-status">
         Unlocked
        </div>
        <div class="lock-owner">
         ç„¡æŒæœ‰è€…
        </div>
       </div>
      </div>
      <div style="flex: 1; min-width: 280px;">
       <div class="thread-box" id="mutex-t2">
        <div>
         <span class="status-indicator idle" id="mutex-t2-status"></span>åŸ·è¡Œç·’ 2
        </div>
        <div id="mutex-t2-count" style="font-size: 20px; margin: 12px 0;">
         å€‹äººè¨ˆæ•¸: 0
        </div>
        <div id="mutex-t2-state" style="font-size: 14px; opacity: 0.9;">
         ç‹€æ…‹: Idle
        </div>
       </div>
       <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;"><button class="btn" id="t2-lock-btn" onclick="threadLock(2)" style="font-size: 15px; padding: 12px;">ğŸ”’ k_mutex_lock()</button> <button class="btn" id="t2-unlock-btn" onclick="threadUnlock(2)" style="font-size: 15px; padding: 12px;" disabled>ğŸ”“ k_mutex_unlock()</button> <button class="btn btn-success" id="t2-counter-btn" onclick="threadIncrement(2)" style="font-size: 15px; padding: 12px;">â• counter++</button>
       </div>
      </div>
     </div>
     <div class="counter-display" id="mutex-counter">
      å…±äº«è¨ˆæ•¸å™¨ (Shared Counter): 0
     </div>
     <div class="control-panel"><button class="btn" onclick="resetMutexDemo()" style="font-size: 18px; padding: 16px 32px;">ğŸ”„ é‡ç½®å…¨éƒ¨</button>
     </div>
     <div class="log-area" id="mutex-log"></div>
     <h3>ç¨‹å¼ç¢¼ç¯„ä¾‹</h3>
     <div class="code-example"><span class="code-keyword">static</span> <span class="code-keyword">volatile</span> uint32_t counter = 0; K_MUTEX_DEFINE(counter_lock); <span class="code-keyword">void</span> <span class="code-function">thread_function</span>() { <span class="code-comment">/* æ­¥é©Ÿ 1: å–å¾—é– */</span> <span class="code-function">k_mutex_lock</span>(&amp;counter_lock, K_FOREVER); <span class="code-comment">/* æ­¥é©Ÿ 2: è‡¨ç•Œå€ - åªæœ‰æŒæœ‰é–çš„åŸ·è¡Œç·’å¯ä»¥åŸ·è¡Œ */</span> counter++; <span class="code-comment">/* æ­¥é©Ÿ 3: é‡‹æ”¾é–ï¼ˆå¿…é ˆç”±æŒæœ‰è€…é‡‹æ”¾ï¼‰*/</span> <span class="code-function">k_mutex_unlock</span>(&amp;counter_lock); }
     </div>
    </div><!-- Semaphore Event Demo -->
    <div class="demo-section">
     <h2>ğŸ“¡ Semaphore ç¤ºç¯„ Aï¼šISR â†’ åŸ·è¡Œç·’é€šçŸ¥</h2>
     <div class="explanation"><strong>æƒ…å¢ƒï¼š</strong>æ¨¡æ“¬æ¯ç§’çš„ Timer ISR ç™¼å‡ºé€šçŸ¥ï¼Œå·¥ä½œåŸ·è¡Œç·’æ”¶åˆ°å¾Œæ‰è™•ç†å–æ¨£ã€‚<br><strong>é‡é»ï¼š</strong><code>k_sem_give()</code> å¯åœ¨ ISR å‘¼å«ï¼Œè€Œ Mutex ä¸è¡Œï¼
     </div>
     <div class="visualization">
      <div class="thread-box" id="sem-isr">
       <div>
        â° Timer ISR
       </div>
       <div id="sem-isr-status">
        ç­‰å¾…è§¸ç™¼...
       </div>
      </div>
      <div class="thread-box" id="sem-worker">
       <div>
        <span class="status-indicator waiting" id="sem-worker-status"></span>å·¥ä½œåŸ·è¡Œç·’
       </div>
       <div id="sem-worker-status-text">
        ç­‰å¾…é€šçŸ¥...
       </div>
      </div>
     </div>
     <div class="counter-display" id="sem-event-counter">
      å·²è™•ç†å–æ¨£: 0
     </div>
     <div class="control-panel"><button class="btn" id="sem-start-btn" onclick="startSemaphoreDemo()">â–¶ï¸ å•Ÿå‹• Timer</button> <button class="btn btn-secondary" id="sem-stop-btn" onclick="stopSemaphoreDemo()" disabled>â¸ï¸ åœæ­¢ Timer</button> <button class="btn" id="sem-reset-btn" onclick="resetSemaphoreDemo()">ğŸ”„ é‡ç½®</button>
     </div>
     <div class="log-area" id="sem-log"></div>
     <h3>ç¨‹å¼ç¢¼ç¯„ä¾‹</h3>
     <div class="code-example">
      K_SEM_DEFINE(sample_sem, 0, 1); <span class="code-keyword">static void</span> <span class="code-function">timer_handler</span>() { <span class="code-comment">/* ISR contextï¼šåªåšç™¼è¨Šè™Ÿ */</span> <span class="code-function">k_sem_give</span>(&amp;sample_sem); } <span class="code-keyword">void</span> <span class="code-function">worker</span>() { <span class="code-keyword">while</span> (1) { <span class="code-function">k_sem_take</span>(&amp;sample_sem, K_FOREVER); <span class="code-comment">/* çœŸæ­£å·¥ä½œæ”¾åœ¨åŸ·è¡Œç·’åš */</span> process_sampling(); } }
     </div>
    </div><!-- Semaphore Resource Pool Demo -->
    <div class="demo-section">
     <h2>ğŸ¯ Semaphore ç¤ºç¯„ Bï¼šè³‡æºæ± ï¼ˆæœ€å¤š 3 å€‹ï¼‰</h2>
     <div class="explanation"><strong>æƒ…å¢ƒï¼š</strong>ç³»çµ±åŒæ™‚æœ€å¤šå…è¨± 3 å€‹ DMA buffer è¢«ä½¿ç”¨ã€‚<br><strong>ç¬¬ 4 å€‹å˜—è©¦ï¼š</strong>æœƒé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰äººé‡‹æ”¾è³‡æºã€‚
     </div>
     <div class="semaphore-counter" id="sem-slots">
      <div class="sem-slot available">
       1
      </div>
      <div class="sem-slot available">
       2
      </div>
      <div class="sem-slot available">
       3
      </div>
     </div>
     <div class="counter-display" id="sem-pool-status">
      å¯ç”¨è³‡æº: 3 / 3
     </div>
     <div class="control-panel"><button class="btn" onclick="acquireResource()">ğŸ”½ å–å¾—è³‡æº (take)</button> <button class="btn btn-secondary" onclick="releaseResource()">ğŸ”¼ é‡‹æ”¾è³‡æº (give)</button> <button class="btn" onclick="resetPoolDemo()">ğŸ”„ é‡ç½®</button>
     </div>
     <div class="log-area" id="pool-log"></div>
     <h3>ç¨‹å¼ç¢¼ç¯„ä¾‹</h3>
     <div class="code-example"><span class="code-comment">/* åˆå§‹å¯ç”¨ 3 å€‹ï¼Œæœ€å¤§ 3 å€‹ */</span> K_SEM_DEFINE(buf_sem, 3, 3); <span class="code-keyword">void</span> <span class="code-function">use_buffer</span>() { <span class="code-comment">/* æ²’åé¡å°±ç­‰å¾… */</span> <span class="code-function">k_sem_take</span>(&amp;buf_sem, K_FOREVER); <span class="code-comment">/* ä½¿ç”¨ buffer ... */</span> do_work(); <span class="code-comment">/* ç”¨å®Œæ­¸é‚„åé¡ */</span> <span class="code-function">k_sem_give</span>(&amp;buf_sem); }
     </div>
    </div><!-- Comparison Table -->
    <div class="demo-section">
     <h2>ğŸ“Š Semaphore vs Mutex æ¯”è¼ƒè¡¨</h2>
     <table class="comparison-table">
      <thead>
       <tr>
        <th>é …ç›®</th>
        <th>Semaphoreï¼ˆè¨Šè™Ÿé‡ï¼‰</th>
        <th>Mutexï¼ˆäº’æ–¥é–ï¼‰</th>
       </tr>
      </thead>
      <tbody>
       <tr>
        <td><strong>æœ¬è³ª</strong></td>
        <td>ä¸€å€‹è¨ˆæ•¸å™¨ï¼ˆå¯è¨­å®šæœ€å¤§å€¼ï¼‰</td>
        <td>ä¸€æŠŠé–ï¼ˆä¸€æ¬¡åªèƒ½ä¸€å€‹æŒæœ‰è€…ï¼‰</td>
       </tr>
       <tr>
        <td><strong>æ“æœ‰æ¬Š</strong></td>
        <td>ç„¡æ“æœ‰è€…ï¼šA takeï¼ŒB ä¹Ÿèƒ½ give</td>
        <td>æœ‰æ“æœ‰è€…ï¼šèª° lock å°±å¿…é ˆèª° unlock</td>
       </tr>
       <tr>
        <td><strong>ä¸»è¦ç”¨é€”</strong></td>
        <td>1) äº‹ä»¶/é€šçŸ¥<br>
         2) è³‡æºæ± ç®¡ç†</td>
        <td>ä¿è­·è‡¨ç•Œå€ï¼ˆåŒæ™‚åƒ…ä¸€åŸ·è¡Œç·’å¯é€²å…¥ï¼‰</td>
       </tr>
       <tr>
        <td><strong>ISR ä½¿ç”¨</strong></td>
        <td>âœ… k_sem_give() å¯åœ¨ ISR å‘¼å«</td>
        <td>âŒ ä¸èƒ½åœ¨ ISR lock/unlock</td>
       </tr>
       <tr>
        <td><strong>å„ªå…ˆæ¬Šåè½‰</strong></td>
        <td>æ²’æœ‰å…§å»ºè™•ç†æ©Ÿåˆ¶</td>
        <td>âœ… Zephyr å…·å„ªå…ˆæ¬Šç¹¼æ‰¿</td>
       </tr>
       <tr>
        <td><strong>Race Condition</strong></td>
        <td>ç„¡æ³•é˜²æ­¢ï¼ˆè¨­è¨ˆç›®çš„ä¸åŒï¼‰</td>
        <td>âœ… å¯é˜²æ­¢å¤šåŸ·è¡Œç·’åŒæ™‚å­˜å–å…±äº«è³‡æº</td>
       </tr>
      </tbody>
     </table>
     <div class="highlight-box" style="background: #fff5e6; border-color: #ffa726;">
      <h4 style="color: #e65100;">ğŸ¯ é¸æ“‡æ±ºç­–</h4>
      <ul style="line-height: 2; margin: 0;">
       <li><strong>ä¿è­·å…±äº«è³‡æ–™çš„è‡¨ç•Œå€</strong> â†’ ç”¨ <strong>Mutex</strong></li>
       <li><strong>ISR/è£ç½® â†’ åŸ·è¡Œç·’çš„å–šé†’/é€šçŸ¥</strong> â†’ ç”¨ <strong>Semaphore</strong></li>
       <li><strong>å›ºå®šæ•¸é‡è³‡æºæ± </strong> â†’ ç”¨ <strong>Counting Semaphore</strong></li>
       <li><strong>åƒè¬åˆ¥</strong>åœ¨ ISR ç”¨ mutexï¼›ä¹Ÿä¸è¦ç”¨ semaphore ç•¶äº’æ–¥é–</li>
      </ul>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Mutex Demo State
        let useMutex = true;
        let mutexLocked = false;
        let mutexOwner = null;
        let sharedCounter = 0;
        let thread1Count = 0;
        let thread2Count = 0;
        let thread1Reading = null;
        let thread2Reading = null;

        // Semaphore Event Demo State
        let semEventCounter = 0;
        let semTimer = null;
        let semRunning = false;

        // Semaphore Pool Demo State
        let poolAvailable = 3;
        const MAX_RESOURCES = 3;

        function addLog(message, type = 'normal') {
            const logArea = document.getElementById('mutex-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (type === 'success') entry.classList.add('success');
            if (type === 'error') entry.classList.add('error');
            if (type === 'warning') entry.classList.add('warning');
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function addSemLog(logId, message) {
            const logArea = document.getElementById(logId);
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateLockVisual() {
            const lockContainer = document.getElementById('mutex-lock-visual');
            const lockIcon = lockContainer.querySelector('.lock-icon');
            const lockStatus = lockContainer.querySelector('.lock-status');
            const lockOwner = lockContainer.querySelector('.lock-owner');
            
            if (mutexLocked && mutexOwner) {
                lockContainer.className = 'mutex-lock-container locked';
                lockIcon.textContent = 'ğŸ”’';
                lockStatus.textContent = 'Locked';
                lockOwner.textContent = `æŒæœ‰è€…: åŸ·è¡Œç·’ ${mutexOwner}`;
            } else {
                lockContainer.className = 'mutex-lock-container';
                lockIcon.textContent = 'ğŸ”“';
                lockStatus.textContent = 'Unlocked';
                lockOwner.textContent = 'ç„¡æŒæœ‰è€…';
            }
        }

        function updateThreadDisplay(threadNum) {
            const count = threadNum === 1 ? thread1Count : thread2Count;
            document.getElementById(`mutex-t${threadNum}-count`).textContent = `å€‹äººè¨ˆæ•¸: ${count}`;
            
            const hasLock = mutexOwner === threadNum;
            const box = document.getElementById(`mutex-t${threadNum}`);
            const status = document.getElementById(`mutex-t${threadNum}-status`);
            
            if (hasLock) {
                box.classList.add('locked');
                status.className = 'status-indicator active';
                document.getElementById(`mutex-t${threadNum}-state`).textContent = 'ç‹€æ…‹: æŒæœ‰é–';
            } else {
                box.classList.remove('locked');
                status.className = 'status-indicator idle';
                document.getElementById(`mutex-t${threadNum}-state`).textContent = 'ç‹€æ…‹: Idle';
            }
        }

        function updateButtons() {
            const t1HasLock = mutexOwner === 1;
            const t2HasLock = mutexOwner === 2;
            const anyLocked = mutexLocked;

            if (useMutex) {
                document.getElementById('t1-lock-btn').disabled = anyLocked;
                document.getElementById('t1-unlock-btn').disabled = !t1HasLock;
                document.getElementById('t1-counter-btn').disabled = false;

                document.getElementById('t2-lock-btn').disabled = anyLocked;
                document.getElementById('t2-unlock-btn').disabled = !t2HasLock;
                document.getElementById('t2-counter-btn').disabled = false;
            } else {
                document.getElementById('t1-lock-btn').disabled = true;
                document.getElementById('t1-unlock-btn').disabled = true;
                document.getElementById('t1-counter-btn').disabled = false;
                
                document.getElementById('t2-lock-btn').disabled = true;
                document.getElementById('t2-unlock-btn').disabled = true;
                document.getElementById('t2-counter-btn').disabled = false;
            }
        }

        function setMode(withMutex) {
            useMutex = withMutex;
            resetMutexDemo();
            
            const modeText = document.getElementById('current-mode');
            if (withMutex) {
                modeText.textContent = 'ç•¶å‰æ¨¡å¼ï¼šâœ… ä½¿ç”¨ Mutex ä¿è­·';
                modeText.style.color = '#28a745';
                addLog('æ¨¡å¼åˆ‡æ›ï¼šâœ… ä½¿ç”¨ Mutex ä¿è­·æ¨¡å¼', 'success');
            } else {
                modeText.textContent = 'ç•¶å‰æ¨¡å¼ï¼šâŒ ä¸ä½¿ç”¨ Mutexï¼ˆæœƒç™¼ç”Ÿ Race Conditionï¼‰';
                modeText.style.color = '#dc3545';
                addLog('æ¨¡å¼åˆ‡æ›ï¼šâŒ ä¸ä½¿ç”¨ Mutex - æº–å‚™é«”é©— Race Conditionï¼', 'warning');
                addLog('æç¤ºï¼šåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå…©å€‹åŸ·è¡Œç·’å¯èƒ½åŒæ™‚è®€å–ç›¸åŒçš„ counter å€¼', 'warning');
            }
            
            updateButtons();
        }

        function threadLock(threadNum) {
            if (!useMutex) return;
            
            if (mutexLocked) {
                addLog(`åŸ·è¡Œç·’ ${threadNum}: k_mutex_lock() å¤±æ•— âŒ - Mutex å·²è¢«åŸ·è¡Œç·’ ${mutexOwner} æŒæœ‰`, 'error');
                return;
            }

            mutexLocked = true;
            mutexOwner = threadNum;
            addLog(`åŸ·è¡Œç·’ ${threadNum}: k_mutex_lock() æˆåŠŸ âœ… - å–å¾— Mutex æ“æœ‰æ¬Š`, 'success');
            
            updateLockVisual();
            updateThreadDisplay(threadNum);
            updateButtons();
        }

        function threadUnlock(threadNum) {
            if (!useMutex) return;
            
            if (mutexOwner !== threadNum) {
                addLog(`åŸ·è¡Œç·’ ${threadNum}: k_mutex_unlock() å¤±æ•— âŒ - åªæœ‰æŒæœ‰è€…ï¼ˆåŸ·è¡Œç·’ ${mutexOwner}ï¼‰æ‰èƒ½é‡‹æ”¾`, 'error');
                return;
            }

            mutexLocked = false;
            mutexOwner = null;
            addLog(`åŸ·è¡Œç·’ ${threadNum}: k_mutex_unlock() æˆåŠŸ âœ… - é‡‹æ”¾ Mutex`, 'success');
            
            updateLockVisual();
            updateThreadDisplay(threadNum);
            updateButtons();
        }

        function threadIncrement(threadNum) {
            if (useMutex) {
                if (mutexOwner !== threadNum) {
                    addLog(`åŸ·è¡Œç·’ ${threadNum}: counter++ å¤±æ•— âŒ - æœªæŒæœ‰ Mutexï¼Œç„¡æ³•é€²å…¥è‡¨ç•Œå€`, 'error');
                    return;
                }
                
                addLog(`åŸ·è¡Œç·’ ${threadNum}: ã€è‡¨ç•Œå€ã€‘è®€å– counter = ${sharedCounter}`, 'success');
                sharedCounter++;
                if (threadNum === 1) thread1Count++;
                else thread2Count++;
                
                addLog(`åŸ·è¡Œç·’ ${threadNum}: ã€è‡¨ç•Œå€ã€‘counter++ å®Œæˆï¼Œæ–°å€¼ = ${sharedCounter}`, 'success');
                
            } else {
                const otherThread = threadNum === 1 ? 2 : 1;
                const thisReading = threadNum === 1 ? 'thread1Reading' : 'thread2Reading';
                const otherReading = threadNum === 1 ? 'thread2Reading' : 'thread1Reading';
                
                if (eval(thisReading) === null) {
                    eval(`${thisReading} = sharedCounter`);
                    addLog(`åŸ·è¡Œç·’ ${threadNum}: è®€å– counter = ${sharedCounter}`, 'warning');
                    
                    const box = document.getElementById(`mutex-t${threadNum}`);
                    box.classList.add('working');
                    setTimeout(() => box.classList.remove('working'), 800);
                    
                    if (eval(otherReading) !== null && eval(otherReading) === eval(thisReading)) {
                        addLog(`âš ï¸ åµæ¸¬åˆ° Race Conditionï¼å…©å€‹åŸ·è¡Œç·’éƒ½è®€åˆ°ç›¸åŒçš„å€¼ ${eval(thisReading)}`, 'error');
                    }
                    
                    return;
                }
                
                const readValue = eval(thisReading);
                const newValue = readValue + 1;
                
                const otherReadValue = eval(otherReading);
                if (otherReadValue !== null && otherReadValue === readValue) {
                    addLog(`åŸ·è¡Œç·’ ${threadNum}: å¯«å…¥ ${readValue} + 1 = ${newValue}`, 'warning');
                    sharedCounter = newValue;
                    
                    const warning = document.getElementById('race-warning');
                    warning.classList.add('show');
                    setTimeout(() => warning.classList.remove('show'), 3000);
                    
                    addLog(`ğŸš¨ Race Condition ç™¼ç”Ÿï¼åŸ·è¡Œç·’ ${otherThread} çš„ +1 è¢«è¦†è“‹äº†ï¼`, 'error');
                } else {
                    addLog(`åŸ·è¡Œç·’ ${threadNum}: å¯«å…¥ ${readValue} + 1 = ${newValue}`, 'success');
                    sharedCounter = newValue;
                }
                
                if (threadNum === 1) {
                    thread1Count++;
                    thread1Reading = null;
                } else {
                    thread2Count++;
                    thread2Reading = null;
                }
                
                const box = document.getElementById(`mutex-t${threadNum}`);
                box.classList.add('working');
                setTimeout(() => box.classList.remove('working'), 800);
            }
            
            document.getElementById('mutex-counter').textContent = `å…±äº«è¨ˆæ•¸å™¨ (Shared Counter): ${sharedCounter}`;
            updateThreadDisplay(threadNum);
        }

        function resetMutexDemo() {
            mutexLocked = false;
            mutexOwner = null;
            sharedCounter = 0;
            thread1Count = 0;
            thread2Count = 0;
            thread1Reading = null;
            thread2Reading = null;
            
            document.getElementById('mutex-counter').textContent = `å…±äº«è¨ˆæ•¸å™¨ (Shared Counter): 0`;
            document.getElementById('mutex-log').innerHTML = '';
            document.getElementById('race-warning').classList.remove('show');
            
            updateLockVisual();
            updateThreadDisplay(1);
            updateThreadDisplay(2);
            updateButtons();
            
            addLog('ç³»çµ±é‡ç½®å®Œæˆ', 'success');
        }

        function startSemaphoreDemo() {
            if (semRunning) return;
            
            semRunning = true;
            semEventCounter = 0;
            document.getElementById('sem-event-counter').textContent = `å·²è™•ç†å–æ¨£: ${semEventCounter}`;
            document.getElementById('sem-log').innerHTML = '';
            document.getElementById('sem-start-btn').disabled = true;
            document.getElementById('sem-stop-btn').disabled = false;
            
            document.getElementById('sem-worker-status').className = 'status-indicator waiting';
            document.getElementById('sem-worker-status-text').textContent = 'ç­‰å¾…é€šçŸ¥...';
            
            addSemLog('sem-log', 'â° Timer å·²å•Ÿå‹•');
            
            semTimer = setInterval(() => {
                document.getElementById('sem-isr').className = 'thread-box working';
                document.getElementById('sem-isr-status').textContent = 'ğŸ”” ç™¼å‡ºé€šçŸ¥';
                addSemLog('sem-log', 'ISR: k_sem_give() - ç™¼å‡ºå–æ¨£é€šçŸ¥');
                
                setTimeout(() => {
                    document.getElementById('sem-isr').className = 'thread-box';
                    document.getElementById('sem-isr-status').textContent = 'ç­‰å¾…ä¸‹æ¬¡è§¸ç™¼...';
                }, 200);
                
                setTimeout(() => {
                    document.getElementById('sem-worker').className = 'thread-box working';
                    document.getElementById('sem-worker-status').className = 'status-indicator active';
                    document.getElementById('sem-worker-status-text').textContent = 'è™•ç†ä¸­...';
                    addSemLog('sem-log', 'å·¥ä½œåŸ·è¡Œç·’: k_sem_take() æˆåŠŸï¼Œé–‹å§‹è™•ç†');
                    
                    setTimeout(() => {
                        semEventCounter++;
                        document.getElementById('sem-event-counter').textContent = `å·²è™•ç†å–æ¨£: ${semEventCounter}`;
                        document.getElementById('sem-worker').className = 'thread-box';
                        document.getElementById('sem-worker-status').className = 'status-indicator waiting';
                        document.getElementById('sem-worker-status-text').textContent = 'ç­‰å¾…é€šçŸ¥...';
                        addSemLog('sem-log', `è™•ç†å®Œæˆï¼ç¸½è¨ˆ: ${semEventCounter}`);
                    }, 300);
                }, 400);
                
            }, 1500);
        }

        function stopSemaphoreDemo() {
            if (!semRunning) return;
            
            semRunning = false;
            clearInterval(semTimer);
            document.getElementById('sem-start-btn').disabled = false;
            document.getElementById('sem-stop-btn').disabled = true;
            
            document.getElementById('sem-isr').className = 'thread-box';
            document.getElementById('sem-isr-status').textContent = 'å·²åœæ­¢';
            document.getElementById('sem-worker').className = 'thread-box';
            document.getElementById('sem-worker-status').className = 'status-indicator idle';
            document.getElementById('sem-worker-status-text').textContent = 'å·²åœæ­¢';
            
            addSemLog('sem-log', 'â¸ï¸ Timer å·²åœæ­¢');
        }

        function resetSemaphoreDemo() {
            stopSemaphoreDemo();
            semEventCounter = 0;
            document.getElementById('sem-event-counter').textContent = `å·²è™•ç†å–æ¨£: 0`;
            document.getElementById('sem-log').innerHTML = '';
            document.getElementById('sem-isr-status').textContent = 'ç­‰å¾…è§¸ç™¼...';
            document.getElementById('sem-worker-status-text').textContent = 'ç­‰å¾…é€šçŸ¥...';
        }

        function updatePoolDisplay() {
            document.getElementById('sem-pool-status').textContent = `å¯ç”¨è³‡æº: ${poolAvailable} / ${MAX_RESOURCES}`;
            
            const slots = document.querySelectorAll('#sem-slots .sem-slot');
            slots.forEach((slot, index) => {
                if (index < MAX_RESOURCES - poolAvailable) {
                    slot.className = 'sem-slot taken';
                    slot.textContent = 'âœ–';
                } else {
                    slot.className = 'sem-slot available';
                    slot.textContent = (index + 1).toString();
                }
            });
        }

        function acquireResource() {
            if (poolAvailable > 0) {
                poolAvailable--;
                updatePoolDisplay();
                addSemLog('pool-log', `âœ… k_sem_take() æˆåŠŸ - å–å¾—è³‡æº (å‰©é¤˜: ${poolAvailable})`);
            } else {
                addSemLog('pool-log', `âš ï¸ k_sem_take() ç­‰å¾…ä¸­ - ç„¡å¯ç”¨è³‡æºï¼`);
            }
        }

        function releaseResource() {
            if (poolAvailable < MAX_RESOURCES) {
                poolAvailable++;
                updatePoolDisplay();
                addSemLog('pool-log', `ğŸ”„ k_sem_give() - é‡‹æ”¾è³‡æº (å‰©é¤˜: ${poolAvailable})`);
            } else {
                addSemLog('pool-log', `âš ï¸ ç„¡æ³•é‡‹æ”¾ - å·²é”æœ€å¤§å€¼ï¼`);
            }
        }

        function resetPoolDemo() {
            poolAvailable = MAX_RESOURCES;
            updatePoolDisplay();
            document.getElementById('pool-log').innerHTML = '';
            addSemLog('pool-log', 'ğŸ”„ è³‡æºæ± å·²é‡ç½®');
        }

        // Initialize
        updateButtons();
        updatePoolDisplay();
        addLog('ç³»çµ±åˆå§‹åŒ–å®Œæˆ - è«‹é¸æ“‡æ¨¡å¼é–‹å§‹é«”é©—ï¼', 'success');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ab3d533458bb307',t:'MTc2NTI3NjI4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
